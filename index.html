<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>행밥 단체 주문 견적</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f4f4f5;
      color: #111827;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 24px;
      background: #111827;
      color: white;
    }
    header .logo {
      font-weight: 700;
      font-size: 18px;
    }
    header .subtitle {
      font-size: 12px;
      color: #9ca3af;
    }
    main {
      display: flex;
      gap: 16px;
      padding: 16px 24px 24px;
    }

    /* 왼쪽: 음식점 목록 */
    #restaurant-list-view {
      flex: 1;
      max-width: 360px;
    }
    #restaurant-list-view h2 {
      margin-top: 0;
      font-size: 18px;
      margin-bottom: 8px;
    }
    .restaurant-card {
      background: white;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      border: 1px solid #e5e7eb;
      transition: box-shadow 0.15s ease, transform 0.1s ease, border-color 0.1s ease;
      overflow: hidden;
    }
    .restaurant-card:hover {
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      transform: translateY(-1px);
      border-color: #111827;
    }
    .restaurant-thumb {
      width: 100%;
      height: 140px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 8px;
      background-color: #f3f4f6;
    }
    .restaurant-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .restaurant-meta {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .restaurant-tag {
      display: inline-block;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #eef2ff;
      color: #4f46e5;
      margin-right: 4px;
    }

    /* 오른쪽: 상세 + 주문폼 */
    #right-panel {
      flex: 2;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 14px;
      border: 1px solid #e5e7eb;
    }
    .card h2 {
      margin-top: 0;
      font-size: 18px;
      margin-bottom: 8px;
    }
    .card h3 {
      margin-top: 12px;
      font-size: 15px;
      margin-bottom: 4px;
    }
    .small {
      font-size: 12px;
      color: #6b7280;
    }
    
    /* 상세페이지 대표 이미지 스타일 */
    .detail-hero-img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 12px;
      background-color: #f3f4f6;
      display: none;
      cursor: zoom-in; /* 커서가 돋보기 모양으로 변함 */
      transition: opacity 0.2s;
    }
    .detail-hero-img:hover {
      opacity: 0.9;
    }

    /* 이미지 확대 모달 (팝업) 스타일 */
    #image-modal {
      display: none; /* 기본적으로 숨김 */
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.85); /* 검은색 반투명 배경 */
      justify-content: center;
      align-items: center;
      cursor: zoom-out;
    }
    #image-modal img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      cursor: default;
    }

    .pill {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      display: inline-block;
      margin-right: 4px;
      margin-top: 2px;
    }
    .pill-yes {
      background: #dcfce7;
      color: #166534;
    }
    .pill-no {
      background: #fee2e2;
      color: #991b1b;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #f3f4f6;
      text-align: left;
    }
    th {
      background: #f9fafb;
    }
    .menu-row input[type="number"] {
      width: 60px;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-top: 12px;
      margin-bottom: 6px;
    }

    .btn-primary {
      padding: 8px 12px;
      border-radius: 999px;
      border: none;
      background: #111827;
      color: white;
      font-size: 13px;
      cursor: pointer;
    }
    .btn-secondary {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: white;
      font-size: 12px;
      cursor: pointer;
    }
    .field {
      margin-bottom: 10px;
    }
    .field label {
      display: block;
      font-size: 13px;
      margin-bottom: 3px;
    }
    .field input, .field textarea, .field select {
      width: 100%;
      padding: 6px 8px;
      font-size: 13px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    .highlight-box {
      border-radius: 10px;
      background: #f9fafb;
      padding: 10px;
      font-size: 12px;
      margin-bottom: 8px;
      border: 1px dashed #e5e7eb;
    }

    @media (max-width: 800px) {
      main {
        flex-direction: column;
      }
      #restaurant-list-view {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>

<header>
  <div>
    <div class="logo">행밥 단체 주문</div>
    <div class="subtitle">학과·동아리·학생회 단체 행사를 위한 간편 견적 요청</div>
  </div>
</header>

<main>
  <section id="restaurant-list-view">
    <h2>참여 음식점</h2>
    <div class="small" style="margin-bottom:8px;">
      주문할 음식점을 선택한 뒤, 오른쪽에서 메뉴 수량을 선택하고 견적서를 제출해주세요.
    </div>
    <div id="restaurant-list"></div>
  </section>

  <section id="right-panel">

    <div id="restaurant-detail-view" class="card">
      <img id="rest-detail-img" class="detail-hero-img" src="" alt="음식점 대표 이미지" title="클릭해서 확대보기" />

      <h2 id="rest-name">음식점을 먼저 선택해주세요</h2>
      <div id="rest-meta" class="small"></div>
      <div id="rest-notice" class="small" style="margin-top:4px;"></div>

      <h3>예약 가능 시간</h3>
      <div id="availability-container" class="small">왼쪽에서 음식점을 선택하면 예약 가능 시간이 표시됩니다.</div>

      <h3>메뉴 / 수량 / 비고</h3>
      <table>
        <thead>
          <tr>
            <th>메뉴</th>
            <th>기본 가격</th>
            <th>수량(최소~최대)</th>
            <th>비고</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="menu-body"></tbody>
      </table>
      <div class="small" style="margin-top:6px;">
        수량을 입력한 뒤 <b>담기</b>를 눌러주세요. 여러 메뉴를 함께 담을 수 있습니다.
      </div>
    </div>

    <div class="card">
      <h2>단체 주문 견적서</h2>
      <div class="highlight-box">
        <div><b>1)</b> 왼쪽에서 음식점 선택</div>
        <div><b>2)</b> 위에서 메뉴·수량 담기</div>
        <div><b>3)</b> 아래 견적서를 작성하고 제출</div>
      </div>
      <div id="cart-summary" class="small" style="margin-bottom:8px;">
        현재 담긴 메뉴가 없습니다. (메뉴를 담으면 여기에서 한 번에 확인할 수 있어요)
      </div>

      <form id="order-form">
        <div class="section-title">단체 정보</div>

        <div class="field">
          <label>단체 이름 / 학생회 이름</label>
          <input type="text" name="단체명" placeholder="예: 사회학과 학생회" required />
        </div>

        <div class="field">
          <label>담당자 이름</label>
          <input type="text" name="담당자명" placeholder="예: 홍길동" required />
        </div>

        <div class="field">
          <label>담당자 연락처</label>
          <input type="text" name="담당자_연락처" placeholder="예: 010-0000-0000" required />
        </div>

        <div class="field">
          <label>담당자 이메일</label>
          <input type="email" name="담당자_이메일" placeholder="견적 회신 받을 이메일" required />
        </div>

        <div class="section-title">배송 / 일정 정보</div>

        <div class="field">
          <label>배송 방법</label>
          <select name="배송_방법" required>
            <option value="">선택하세요</option>
            <option value="배달">배달</option>
            <option value="픽업">픽업</option>
          </select>
        </div>

        <div class="field">
          <label>배달 주소 (또는 픽업 수령 장소)</label>
          <input type="text" name="주소_또는_수령장소" placeholder="예: 고려대학교 ○○관 1층 로비" required />
        </div>

        <div class="field">
          <label>희망 날짜 / 시간</label>
          <input type="text" name="희망_일시" placeholder="예: 12월 10일(화) 11:30" required />
        </div>

        <div class="section-title">추가 요청사항</div>

        <div class="field">
          <label>요청사항 / 참고사항</label>
          <textarea name="추가_요청사항" placeholder="예: 포장 개별 포장 / 비건 메뉴 별도 구분 / 예산 범위 등"></textarea>
        </div>

        <div class="small" style="margin-bottom:8px;">
          제출을 누르면, 선택한 음식점·메뉴·수량·예상금액과 함께 Supabase DB에 저장됩니다.
        </div>

        <button type="submit" class="btn-primary">
          견적 요청 보내기
        </button>
      </form>
    </div>
  </section>
</main>

<div id="image-modal" onclick="closeModal()">
  <img id="modal-full-img" src="" alt="확대 이미지" />
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  // ===== 0. Supabase 연결 (여기만 네 프로젝트 값으로 바꾸기!) =====
  const SUPABASE_URL = "https://owfljerawghlyswtylxs.supabase.co";   // ← 네 프로젝트 URL
  const SUPABASE_KEY = "sb_publishable_izKjuHR5y7O-xJANpPrS_A_ScU3hLrO";          // ← anon 또는 publishable 키

  // CDN으로 불러온 전역 객체: supabase.createClient(...) 사용
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ===== 1. 상태 저장 =====
  const state = {
    selectedRestaurantId: null,
    cart: [] // {restaurantId, menuId, name, qty, price}
  };

  // ===== 2. 음식점 데이터 (imageUrl 추가됨) =====
  const restaurants = [
    {
      id: 'r1',
      name: '본죽',
      imageUrl: 'https://placehold.co/600x400/orange/white?text=Bonjuk',
      meta: '도시락/죽 · 100인 이상 · 3~4일 전 예약',
      tags: ['한식', '속편한 식사', '비빔밥'],
      notice: '포장/배달 가능 여부 확인 필요',
      availability: [],
      menus: [
        { id: 'm1_1', name: '6가지나물비빔밥', price: 10500, minQty: 10, maxQty: 100, note: '' },
        { id: 'm1_2', name: '제육볶음나물비빔밥', price: 11500, minQty: 10, maxQty: 100, note: '' },
        { id: 'm1_3', name: '전복내장해물비빔밥', price: 15500, minQty: 10, maxQty: 100, note: '' },
        { id: 'm1_4', name: '소불고기나물비빔밥', price: 12500, minQty: 10, maxQty: 100, note: '' },
        { id: 'm1_5', name: '고추장육회비빔밥', price: 13000, minQty: 10, maxQty: 100, note: '' },
        { id: 'm1_6', name: '본죽장조림버터비빔밥', price: 12000, minQty: 10, maxQty: 100, note: '' },
        { id: 'm1_7', name: '낙지김치비빔밥', price: 12500, minQty: 10, maxQty: 100, note: '' },
        { id: 'm1_8', name: '불고기낙지비빔밥', price: 13000, minQty: 10, maxQty: 100, note: '' },
        { id: 'm1_9', name: '신짬뽕비빔밥', price: 12500, minQty: 10, maxQty: 100, note: '' },
        { id: 'm1_10', name: '참치야채비빔밥', price: 11500, minQty: 10, maxQty: 100, note: '' }
      ]
    },
    {
      id: 'r2',
      name: '비비당',
      imageUrl: 'https://placehold.co/600x400/green/white?text=Bibidang',
      meta: '비빔밥 · 100인 이상 · 2일 전 예약',
      tags: ['샐러드비빔밥(샐비)', '산채비빔밥', '건강식'],
      notice: '10~20인분 배달무료 / 100인분 이상 금액 협의',
      availability: [],
      menus: [
        { id: 'm2_1', name: '불맛 쭈꾸미삼겹 산채', price: 9900, minQty: 10, maxQty: 200, note: '100인↑ 협의' },
        { id: 'm2_2', name: '불 닭발 샐비', price: 11400, minQty: 10, maxQty: 200, note: '' },
        { id: 'm2_3', name: '큐브 연어 샐비', price: 10500, minQty: 10, maxQty: 200, note: '' },
        { id: 'm2_4', name: '특선 육회 샐비', price: 10500, minQty: 10, maxQty: 200, note: '' },
        { id: 'm2_5', name: '향긋 꼬막 비빔밥', price: 10500, minQty: 10, maxQty: 200, note: '' },
        { id: 'm2_6', name: '활력 장어 샐비', price: 11400, minQty: 10, maxQty: 200, note: '' },
        { id: 'm2_7', name: '특제 소불고기 샐비', price: 10500, minQty: 10, maxQty: 200, note: '' },
        { id: 'm2_8', name: '매콤 쭈꾸미 샐비', price: 10500, minQty: 10, maxQty: 200, note: '' },
        { id: 'm2_9', name: '달콤 불고기 샐비', price: 9000, minQty: 10, maxQty: 200, note: '' },
        { id: 'm2_10', name: '매콤 제육 샐비', price: 9000, minQty: 10, maxQty: 200, note: '' },
        { id: 'm2_11', name: '훈제 오리 샐비', price: 9000, minQty: 10, maxQty: 200, note: '' },
        { id: 'm2_12', name: '그릴 스팸 샐비', price: 8000, minQty: 10, maxQty: 200, note: '' },
        { id: 'm2_13', name: '참치 마요 샐비', price: 8000, minQty: 10, maxQty: 200, note: '' },
        { id: 'm2_14', name: '수비드 닭가슴살 샐비', price: 8000, minQty: 10, maxQty: 200, note: '' },
        { id: 'm2_15', name: '샐러드 비빔밥(기본)', price: 7500, minQty: 10, maxQty: 200, note: '' },
        { id: 'm2_16', name: '활력 장어 산채', price: 12300, minQty: 10, maxQty: 200, note: '' },
        { id: 'm2_17', name: '특제 소불고기 산채', price: 10500, minQty: 10, maxQty: 200, note: '' },
        { id: 'm2_18', name: '매콤 쭈꾸미 산채', price: 10500, minQty: 10, maxQty: 200, note: '' },
        { id: 'm2_19', name: '달콤 불고기 산채', price: 9000, minQty: 10, maxQty: 200, note: '' },
        { id: 'm2_20', name: '매콤 제육 산채', price: 9000, minQty: 10, maxQty: 200, note: '' },
        { id: 'm2_21', name: '훈제 오리 산채', price: 9000, minQty: 10, maxQty: 200, note: '' },
        { id: 'm2_22', name: '그릴 스팸 산채', price: 8000, minQty: 10, maxQty: 200, note: '' },
        { id: 'm2_23', name: '참치 마요 산채', price: 8000, minQty: 10, maxQty: 200, note: '' },
        { id: 'm2_24', name: '수비드 닭가슴살 산채', price: 8000, minQty: 10, maxQty: 200, note: '' },
        { id: 'm2_25', name: '산채 비빔밥(기본)', price: 7500, minQty: 10, maxQty: 200, note: '' }
      ]
    },
    {
      id: 'r3',
      name: '고래돈가스',
      imageUrl: 'https://placehold.co/600x400/brown/white?text=Cutlet',
      meta: '돈가스 · 100개(협의) · 2일 전 예약',
      tags: ['돈가스 전문', '픽업 전용'],
      notice: '1~2시 픽업 불가 / 50개 이상 사전 예약 필수',
      availability: [],
      menus: [
        { id: 'm3_1', name: '돈가스', price: 12000, minQty: 10, maxQty: 100, note: '' }
      ]
    },
    {
      id: 'r4',
      name: '밀플랜비',
      imageUrl: 'https://placehold.co/600x400/red/white?text=MealPlanB',
      meta: '샌드위치/부리또 · 100개(협의) · 5일 전 예약',
      tags: ['핫도그', '부리또', '간편식'],
      notice: '대량 주문 시 사장님 컨펌 후 할인 가능',
      availability: [],
      menus: [
        { id: 'm4_1', name: '수제 소시지 핫도그', price: 5000, minQty: 20, maxQty: 150, note: '' },
        { id: 'm4_2', name: '기본 핫도그', price: 7000, minQty: 20, maxQty: 150, note: '' },
        { id: 'm4_3', name: '감자 핫도그', price: 7500, minQty: 20, maxQty: 150, note: '' },
        { id: 'm4_4', name: '고구마 핫도그', price: 7500, minQty: 20, maxQty: 150, note: '' },
        { id: 'm4_5', name: '미트볼 감자 부리또(기본)', price: 7000, minQty: 20, maxQty: 150, note: '' },
        { id: 'm4_6', name: '치킨라이스 부리또(기본)', price: 7500, minQty: 20, maxQty: 150, note: '' },
        { id: 'm4_7', name: '치킨감자 부리또(기본)', price: 7500, minQty: 20, maxQty: 150, note: '' },
        { id: 'm4_8', name: '소고기라이스 부리또(기본)', price: 7000, minQty: 20, maxQty: 150, note: '' },
        { id: 'm4_9', name: '소고기감자 부리또(기본)', price: 7000, minQty: 20, maxQty: 150, note: '' },
        { id: 'm4_10', name: '미트볼라이스', price: 8000, minQty: 20, maxQty: 150, note: '' },
        { id: 'm4_11', name: '새우감자 부리또(기본)', price: 7000, minQty: 20, maxQty: 150, note: '' }
      ]
    },
    {
      id: 'r5',
      name: '프로마치',
      imageUrl: 'https://placehold.co/600x400/yellow/black?text=Fromachi',
      meta: '샌드위치/파니니 · 100개 · 3~7일 전',
      tags: ['파니니', '샌드위치', '비건옵션'],
      notice: '최소 3일 전 예약, 대량은 1주일 전',
      availability: [],
      menus: [
        { id: 'm5_1', name: '페스토 치킨 파니니', price: 10400, minQty: 10, maxQty: 100, note: '' },
        { id: 'm5_2', name: '포크 파스트라미 파니니', price: 10400, minQty: 10, maxQty: 100, note: '' },
        { id: 'm5_3', name: '커리 치킨 파니니', price: 10300, minQty: 10, maxQty: 100, note: '' },
        { id: 'm5_4', name: '멕시칸 타코 파니니', price: 10900, minQty: 10, maxQty: 100, note: '' },
        { id: 'm5_5', name: '페스토치킨 샌드위치', price: 10400, minQty: 10, maxQty: 100, note: '' },
        { id: 'm5_6', name: '포크 페스트라미 샌드위치', price: 10400, minQty: 10, maxQty: 100, note: '' },
        { id: 'm5_7', name: '베지테리안 딜라이트 샌드위치', price: 10300, minQty: 10, maxQty: 100, note: '비건 메뉴' },
        { id: 'm5_8', name: '이탈리안 콤보 샌드위치', price: 10300, minQty: 10, maxQty: 100, note: '' },
        { id: 'm5_9', name: '커리 치킨 샌드위치', price: 10300, minQty: 10, maxQty: 100, note: '' },
        { id: 'm5_10', name: '멕시칸 타코 샌드위치', price: 10900, minQty: 10, maxQty: 100, note: '' },
        { id: 'm5_11', name: '노르웨이안 연어 샌드위치', price: 12700, minQty: 10, maxQty: 100, note: '' },
        { id: 'm5_12', name: '리코타 치즈 샐러드', price: 9700, minQty: 10, maxQty: 100, note: '' },
        { id: 'm5_13', name: '치킨 시저 샐러드', price: 9400, minQty: 10, maxQty: 100, note: '' },
        { id: 'm5_14', name: '치즈보드 샐러드', price: 10400, minQty: 10, maxQty: 100, note: '' }
      ]
    },
    {
      id: 'r6',
      name: '치비치비',
      imageUrl: 'https://placehold.co/600x400/black/white?text=Chibi',
      meta: '양식/스테이크 · 50개(협의) · 7일 전',
      tags: ['치킨스테이크', '양식'],
      notice: '포장시 음식이 식을 수 있음 / 보통맛·매운맛 선택 가능',
      availability: [],
      menus: [
        { id: 'm6_1', name: '간장 스테이크', price: 11500, minQty: 10, maxQty: 50, note: '보통맛/매운맛' },
        { id: 'm6_2', name: '양념 스테이크', price: 11500, minQty: 10, maxQty: 50, note: '보통맛/매운맛' },
        { id: 'm6_3', name: '칠리 스테이크', price: 11500, minQty: 10, maxQty: 50, note: '보통맛/매운맛' },
        { id: 'm6_4', name: '커리 스테이크', price: 11500, minQty: 10, maxQty: 50, note: '보통맛/매운맛' },
        { id: 'm6_5', name: '치비 스테이크', price: 10500, minQty: 10, maxQty: 50, note: '' }
      ]
    },
    {
      id: 'r7',
      name: '스시미소',
      imageUrl: 'https://placehold.co/600x400/blue/white?text=Sushi',
      meta: '일식 · 100인 이상 · 당일~1일 전',
      tags: ['초밥', '롤', '고급 도시락'],
      notice: '배달은 전날 예약, 오후 주문시 당일 가능 협의',
      availability: [],
      menus: [
        { id: 'm7_1', name: '미소초밥모둠(10p)', price: 15000, minQty: 10, maxQty: 150, note: '' },
        { id: 'm7_2', name: '특초밥모둠(12p)', price: 18000, minQty: 10, maxQty: 150, note: '' },
        { id: 'm7_3', name: '스페셜초밥(12p)', price: 25000, minQty: 10, maxQty: 150, note: '' },
        { id: 'm7_4', name: '연어초밥(10p)', price: 20000, minQty: 10, maxQty: 150, note: '' },
        { id: 'm7_5', name: '광어초밥(10p)', price: 20000, minQty: 10, maxQty: 150, note: '' },
        { id: 'm7_6', name: '연어 초밥(5p)', price: 11000, minQty: 10, maxQty: 150, note: '' },
        { id: 'm7_7', name: '광어 초밥(5p)', price: 11000, minQty: 10, maxQty: 150, note: '' },
        { id: 'm7_8', name: '참치 초밥(5p)', price: 10000, minQty: 10, maxQty: 150, note: '' },
        { id: 'm7_9', name: '황새치 초밥(5p)', price: 10000, minQty: 10, maxQty: 150, note: '' },
        { id: 'm7_10', name: '소고기 초밥(5p)', price: 10000, minQty: 10, maxQty: 150, note: '' },
        { id: 'm7_11', name: '도미 초밥(5p)', price: 15000, minQty: 10, maxQty: 150, note: '' },
        { id: 'm7_12', name: '장어 초밥(5p)', price: 16000, minQty: 10, maxQty: 150, note: '' },
        { id: 'm7_13', name: '혼마구로 초밥(5p)', price: 20000, minQty: 10, maxQty: 150, note: '' },
        { id: 'm7_14', name: '초새우 초밥(5p)', price: 8000, minQty: 10, maxQty: 150, note: '' },
        { id: 'm7_15', name: '생새우 초밥(5p)', price: 8000, minQty: 10, maxQty: 150, note: '' },
        { id: 'm7_16', name: '간장새우 초밥(5p)', price: 9000, minQty: 10, maxQty: 150, note: '' },
        { id: 'm7_17', name: '연어갈릭 아부리(5p)', price: 12000, minQty: 10, maxQty: 150, note: '' },
        { id: 'm7_18', name: '참치갈릭 아부리(5p)', price: 11000, minQty: 10, maxQty: 150, note: '' },
        { id: 'm7_19', name: '생새우갈릭 아부리(5p)', price: 8000, minQty: 10, maxQty: 150, note: '' },
        { id: 'm7_20', name: '계란 초밥(5p)', price: 7500, minQty: 10, maxQty: 150, note: '' },
        { id: 'm7_21', name: '유부 초밥(5p)', price: 7500, minQty: 10, maxQty: 150, note: '' },
        { id: 'm7_22', name: '새우튀김롤', price: 15000, minQty: 10, maxQty: 150, note: '' },
        { id: 'm7_23', name: '연어롤', price: 15000, minQty: 10, maxQty: 150, note: '' },
        { id: 'm7_24', name: '간장새우알밥', price: 13000, minQty: 10, maxQty: 150, note: '' },
        { id: 'm7_25', name: '불고기덮밥', price: 15000, minQty: 10, maxQty: 150, note: '' },
        { id: 'm7_26', name: '회덮밥', price: 16000, minQty: 10, maxQty: 150, note: '' }
      ]
    },
    {
      id: 'r8',
      name: '오봉집',
      imageUrl: 'https://placehold.co/600x400/purple/white?text=Obong',
      meta: '한식/볶음 · 100인 이상 · 1일 전',
      tags: ['직화볶음', '보쌈', '점심할인'],
      notice: '11~15시 점심시간 가격 할인 적용 가능',
      availability: [],
      menus: [
        { id: 'm8_1', name: '직화제육볶음', price: 11000, minQty: 10, maxQty: 150, note: '점심시간 10,000원' },
        { id: 'm8_2', name: '직화낙지볶음', price: 14000, minQty: 10, maxQty: 150, note: '점심시간 12,000원' },
        { id: 'm8_3', name: '직화제낙볶음', price: 14000, minQty: 10, maxQty: 150, note: '점심시간 12,000원' },
        { id: 'm8_4', name: '보쌈정식', price: 10000, minQty: 10, maxQty: 150, note: '' },
        { id: 'm8_5', name: '왕만두(김치/고기/반반)', price: 6000, minQty: 10, maxQty: 150, note: '' },
        { id: 'm8_6', name: '돼지불고기', price: 9000, minQty: 10, maxQty: 150, note: '' }
      ]
    },
    {
      id: 'r9',
      name: '우승식당',
      imageUrl: 'https://placehold.co/600x400/gray/white?text=Wooseung',
      meta: '한식 · 100개(협의) · 당일~1일 전',
      tags: ['제육', '두루치기', '가성비'],
      notice: '50개 이상 주문 시 서비스 협의',
      availability: [],
      menus: [
        { id: 'm9_1', name: '제육볶음', price: 9000, minQty: 10, maxQty: 100, note: '' },
        { id: 'm9_2', name: '쭈육볶음', price: 9500, minQty: 10, maxQty: 100, note: '' },
        { id: 'm9_3', name: '쭈꾸미볶음', price: 11000, minQty: 10, maxQty: 100, note: '' },
        { id: 'm9_4', name: '오리지널두루치기', price: 9000, minQty: 10, maxQty: 100, note: '' }
      ]
    },
    {
      id: 'r10',
      name: '이공김밥',
      imageUrl: 'https://placehold.co/600x400/pink/white?text=Kimbap',
      meta: '분식 · 100인 이상 · 1~3일 전',
      tags: ['김밥', '돈가스', '가성비'],
      notice: '오전 일찍 픽업 가능, 서비스 제공',
      availability: [],
      menus: [
        { id: 'm10_1', name: '이공김밥', price: 3500, minQty: 20, maxQty: 300, note: '' },
        { id: 'm10_2', name: '참치폭탄김밥', price: 6000, minQty: 20, maxQty: 300, note: '' },
        { id: 'm10_3', name: '더블치즈김밥', price: 4500, minQty: 20, maxQty: 300, note: '' },
        { id: 'm10_4', name: '고추김밥', price: 4500, minQty: 20, maxQty: 300, note: '' },
        { id: 'm10_5', name: '김치김밥', price: 4500, minQty: 20, maxQty: 300, note: '' },
        { id: 'm10_6', name: '샐러드김밥', price: 4500, minQty: 20, maxQty: 300, note: '' },
        { id: 'm10_7', name: '작은참치김밥', price: 5000, minQty: 20, maxQty: 300, note: '' },
        { id: 'm10_8', name: '참치김치김밥', price: 6000, minQty: 20, maxQty: 300, note: '' },
        { id: 'm10_9', name: '콘참치김밥', price: 6000, minQty: 20, maxQty: 300, note: '' },
        { id: 'm10_10', name: '제육김밥', price: 6000, minQty: 20, maxQty: 300, note: '' },
        { id: 'm10_11', name: '갈비김밥', price: 6000, minQty: 20, maxQty: 300, note: '' },
        { id: 'm10_12', name: '돈까스김밥', price: 6000, minQty: 20, maxQty: 300, note: '' },
        { id: 'm10_13', name: '야채돈가스김밥', price: 6500, minQty: 20, maxQty: 300, note: '' },
        { id: 'm10_14', name: '참치누드김밥', price: 9000, minQty: 20, maxQty: 300, note: '' },
        { id: 'm10_15', name: '고기만두(8개)', price: 5500, minQty: 10, maxQty: 150, note: '' },
        { id: 'm10_16', name: '김치만두(8개)', price: 5500, minQty: 10, maxQty: 150, note: '' },
        { id: 'm10_17', name: '물만두(20개)', price: 5500, minQty: 10, maxQty: 150, note: '' },
        { id: 'm10_18', name: '참치김치볶음밥', price: 7500, minQty: 10, maxQty: 150, note: '' },
        { id: 'm10_19', name: '스팸김치볶음밥', price: 7500, minQty: 10, maxQty: 150, note: '' },
        { id: 'm10_20', name: '제육덮밥', price: 8000, minQty: 10, maxQty: 150, note: '' },
        { id: 'm10_21', name: '치즈돈가스', price: 8000, minQty: 10, maxQty: 100, note: '' },
        { id: 'm10_22', name: '고구마돈가스', price: 7500, minQty: 10, maxQty: 100, note: '' },
        { id: 'm10_23', name: '등심돈가스', price: 7500, minQty: 10, maxQty: 100, note: '' }
      ]
    }
  ];

  // ===== 3. 렌더링 함수들 =====
  function init() {
    renderRestaurantList();
    if (restaurants.length > 0) {
      state.selectedRestaurantId = restaurants[0].id;
      renderRestaurantDetail();
    }
    renderCartSummary();

    const form = document.getElementById('order-form');
    form.addEventListener('submit', submitOrder);
  }

  function renderRestaurantList() {
    const container = document.getElementById('restaurant-list');
    container.innerHTML = '';
    restaurants.forEach(r => {
      const card = document.createElement('div');
      card.className = 'restaurant-card';
      card.onclick = () => {
        state.selectedRestaurantId = r.id;
        renderRestaurantDetail();
        state.cart = state.cart.filter(item => item.restaurantId === r.id);
        renderCartSummary();
      };

      // 목록 썸네일 이미지
      if (r.imageUrl) {
        const img = document.createElement('img');
        img.className = 'restaurant-thumb';
        img.src = r.imageUrl;
        img.alt = r.name + ' 이미지';
        card.appendChild(img);
      }

      const nameDiv = document.createElement('div');
      nameDiv.className = 'restaurant-name';
      nameDiv.textContent = r.name;

      const metaDiv = document.createElement('div');
      metaDiv.className = 'restaurant-meta';
      metaDiv.textContent = r.meta;

      const tagsDiv = document.createElement('div');
      r.tags.forEach(t => {
        const tagSpan = document.createElement('span');
        tagSpan.className = 'restaurant-tag';
        tagSpan.textContent = t;
        tagsDiv.appendChild(tagSpan);
      });

      card.appendChild(nameDiv);
      card.appendChild(metaDiv);
      card.appendChild(tagsDiv);

      container.appendChild(card);
    });
  }

  function getSelectedRestaurant() {
    return restaurants.find(r => r.id === state.selectedRestaurantId) || null;
  }

  function renderRestaurantDetail() {
    const rest = getSelectedRestaurant();
    const nameEl = document.getElementById('rest-name');
    const metaEl = document.getElementById('rest-meta');
    const noticeEl = document.getElementById('rest-notice');
    const availContainer = document.getElementById('availability-container');
    const menuBody = document.getElementById('menu-body');
    const detailImgEl = document.getElementById('rest-detail-img');

    if (!rest) {
      nameEl.textContent = '음식점을 먼저 선택해주세요';
      metaEl.textContent = '';
      noticeEl.textContent = '';
      availContainer.textContent = '왼쪽에서 음식점을 선택하면 예약 가능 시간이 표시됩니다.';
      menuBody.innerHTML = '';
      detailImgEl.style.display = 'none';
      return;
    }

    // 상세페이지 대표 이미지 처리 및 클릭 이벤트 연결
    if (rest.imageUrl) {
      detailImgEl.src = rest.imageUrl;
      detailImgEl.style.display = 'block';
      detailImgEl.onclick = () => openModal(rest.imageUrl); // [중요] 클릭 시 모달 열기
    } else {
      detailImgEl.style.display = 'none';
    }

    nameEl.textContent = rest.name;
    metaEl.textContent = rest.meta;
    noticeEl.textContent = '안내사항: ' + rest.notice;

    // 예약 가능 시간
    availContainer.innerHTML = '';
    rest.availability.forEach(day => {
      const dayDiv = document.createElement('div');
      dayDiv.style.marginBottom = '4px';
      const dateSpan = document.createElement('span');
      dateSpan.style.fontWeight = '600';
      dateSpan.textContent = day.date + ' ';
      dayDiv.appendChild(dateSpan);

      day.slots.forEach(s => {
        const pill = document.createElement('span');
        pill.className = 'pill ' + (s.available ? 'pill-yes' : 'pill-no');
        pill.textContent = s.time + (s.available ? ' 가능' : ' 불가');
        dayDiv.appendChild(pill);
      });

      availContainer.appendChild(dayDiv);
    });

    // 메뉴 리스트
    menuBody.innerHTML = '';
    rest.menus.forEach(menu => {
      const tr = document.createElement('tr');
      tr.className = 'menu-row';

      const tdName = document.createElement('td');
      tdName.textContent = menu.name;

      const tdPrice = document.createElement('td');
      tdPrice.textContent = menu.price.toLocaleString() + '원';

      const tdQty = document.createElement('td');
      const qtyInput = document.createElement('input');
      qtyInput.type = 'number';
      qtyInput.min = menu.minQty;
      qtyInput.max = menu.maxQty;
      qtyInput.value = menu.minQty;
      qtyInput.id = `qty-${rest.id}-${menu.id}`;
      tdQty.appendChild(qtyInput);
      const minMaxSpan = document.createElement('span');
      minMaxSpan.className = 'small';
      minMaxSpan.style.marginLeft = '4px';
      minMaxSpan.textContent = `(${menu.minQty}~${menu.maxQty}개)`;
      tdQty.appendChild(minMaxSpan);

      const tdDiscount = document.createElement('td');
      tdDiscount.textContent = menu.note;

      const tdBtn = document.createElement('td');
      const addBtn = document.createElement('button');
      addBtn.className = 'btn-secondary';
      addBtn.style.fontSize = '11px';
      addBtn.textContent = '담기';
      addBtn.type = 'button';
      addBtn.onclick = () => addToCart(rest.id, menu.id);
      tdBtn.appendChild(addBtn);

      tr.appendChild(tdName);
      tr.appendChild(tdPrice);
      tr.appendChild(tdQty);
      tr.appendChild(tdDiscount);
      tr.appendChild(tdBtn);

      menuBody.appendChild(tr);
    });
  }

  function addToCart(restaurantId, menuId) {
    const rest = restaurants.find(r => r.id === restaurantId);
    if (!rest) return;
    const menu = rest.menus.find(m => m.id === menuId);
    if (!menu) return;

    const qtyInput = document.getElementById(`qty-${restaurantId}-${menuId}`);
    const qty = parseInt(qtyInput.value, 10);
    if (isNaN(qty) || qty < menu.minQty || qty > menu.maxQty) {
      alert(`수량은 ${menu.minQty}~${menu.maxQty}개 사이로 입력해주세요.`);
      return;
    }

    const existing = state.cart.find(
      item => item.restaurantId === restaurantId && item.menuId === menuId
    );
    if (existing) {
      const newQty = existing.qty + qty;
      if (newQty > menu.maxQty) {
        alert(`최대 수량(${menu.maxQty}개)를 초과할 수 없습니다.`);
        return;
      }
      existing.qty = newQty;
    } else {
      state.cart.push({
        restaurantId,
        menuId,
        name: menu.name,
        qty,
        price: menu.price
      });
    }

    alert(`장바구니에 담았습니다.\n(${menu.name} x ${qty}개)`);
    renderCartSummary();
  }

  function renderCartSummary() {
    const summaryEl = document.getElementById('cart-summary');
    const rest = getSelectedRestaurant();
    const items = state.cart;
    if (!rest || items.length === 0) {
      summaryEl.textContent =
        '현재 담긴 메뉴가 없습니다. (메뉴를 담으면 여기에서 한 번에 확인할 수 있어요)';
      return;
    }

    let total = 0;
    let lines = items.map(item => {
      const lineTotal = item.price * item.qty;
      total += lineTotal;
      return `- ${item.name} x ${item.qty}개 = ${lineTotal.toLocaleString()}원`;
    });

    summaryEl.innerHTML =
      `<b>선택한 음식점:</b> ${rest.name}<br>` +
      lines.join('<br>') +
      `<br><br><b>예상 기본 금액 합계: ${total.toLocaleString()}원</b><br>` +
      `<span class="small">※ 실제 할인 및 최종 금액은 가게와 협의 후 확정됩니다.</span>`;
  }

  // ===== 모달 관련 함수 (추가됨) =====
  function openModal(src) {
    const modal = document.getElementById('image-modal');
    const modalImg = document.getElementById('modal-full-img');
    modalImg.src = src;
    modal.style.display = 'flex'; // flex로 중앙 정렬
  }

  function closeModal() {
    const modal = document.getElementById('image-modal');
    modal.style.display = 'none';
  }

  // ===== 4. 주문 제출 → Supabase에 저장 =====
  async function submitOrder(event) {
    event.preventDefault();

    const rest = getSelectedRestaurant();
    if (!rest) {
      alert('먼저 왼쪽에서 음식점을 선택해주세요.');
      return;
    }
    if (state.cart.length === 0) {
      alert('메뉴를 하나 이상 담아주세요.');
      return;
    }

    const form = document.getElementById('order-form');
    const formData = new FormData(form);

    let total = 0;
    const items = state.cart.map(item => {
      const lineTotal = item.price * item.qty;
      total += lineTotal;
      return {
        name: item.name,
        qty: item.qty,
        price: item.price,
        line_total: lineTotal
      };
    });

    const payload = {
      restaurant_id: rest.id,
      restaurant_name: rest.name,
      items: items,
      total_amount: total,

      org_name: formData.get('단체명'),
      contact_name: formData.get('담당자명'),
      contact_phone: formData.get('담당자_연락처'),
      contact_email: formData.get('담당자_이메일'),

      delivery_type: formData.get('배송_방법'),
      address: formData.get('주소_또는_수령장소'),
      desired_datetime: formData.get('희망_일시'),
      memo: formData.get('추가_요청사항')
    };

    try {
      const { error } = await supabaseClient
        .from('orders')
        .insert([payload]);

      if (error) {
        console.error(error);
        alert('주문 저장 중 오류가 발생했습니다. 나중에 다시 시도해주세요.');
        return;
      }

      alert('견적 요청이 접수되었습니다! 행밥 팀에서 확인 후 연락드릴게요.');

      form.reset();
      state.cart = [];
      renderCartSummary();
    } catch (e) {
      console.error(e);
      alert('일시적인 오류가 발생했습니다. 나중에 다시 시도해주세요.');
    }
  }

  window.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
