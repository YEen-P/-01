<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>행밥 단체 주문 견적</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f4f4f5;
      color: #111827;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 24px;
      background: #111827;
      color: white;
    }
    header .logo {
      font-weight: 700;
      font-size: 18px;
    }
    header .subtitle {
      font-size: 12px;
      color: #9ca3af;
    }
    main {
      display: flex;
      gap: 16px;
      padding: 16px 24px 24px;
    }

    /* 왼쪽: 음식점 목록 */
    #restaurant-list-view {
      flex: 1;
      max-width: 360px;
    }
    #restaurant-list-view h2 {
      margin-top: 0;
      font-size: 18px;
      margin-bottom: 8px;
    }
    .restaurant-card {
      background: white;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      border: 1px solid #e5e7eb;
      transition: box-shadow 0.15s ease, transform 0.1s ease, border-color 0.1s ease;
      overflow: hidden;
    }
    .restaurant-card:hover {
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      transform: translateY(-1px);
      border-color: #111827;
    }
    .restaurant-thumb {
      width: 100%;
      height: 140px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 8px;
      background-color: #f3f4f6;
    }
    .restaurant-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .restaurant-meta {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .restaurant-tag {
      display: inline-block;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #eef2ff;
      color: #4f46e5;
      margin-right: 4px;
    }

    /* 오른쪽: 상세 + 주문폼 */
    #right-panel {
      flex: 2;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 14px;
      border: 1px solid #e5e7eb;
    }
    .card h2 {
      margin-top: 0;
      font-size: 18px;
      margin-bottom: 8px;
    }
    .card h3 {
      margin-top: 12px;
      font-size: 15px;
      margin-bottom: 4px;
    }
    .small {
      font-size: 12px;
      color: #6b7280;
    }
    
    /* ===== 갤러리 스타일 (수정됨) ===== */
    .gallery-container {
      margin-bottom: 16px;
    }
    
    /* 메인 이미지: 세로 사진도 잘리지 않게 contain 사용 + 배경색 */
    .gallery-main-frame {
      width: 100%;
      height: 300px; /* 높이 고정 */
      background-color: #f9fafb; /* 빈 공간 배경색 */
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      margin-bottom: 8px;
      cursor: zoom-in;
    }
    .gallery-main-img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain; /* 비율 유지하며 다 보여주기 */
      display: none; /* JS로 제어 */
    }

    /* 썸네일 리스트 */
    .gallery-thumbs {
      display: flex;
      gap: 6px;
      overflow-x: auto; /* 가로 스크롤 */
      padding-bottom: 4px;
    }
    .gallery-thumb-item {
      width: 60px;
      height: 60px;
      flex-shrink: 0;
      border-radius: 6px;
      cursor: pointer;
      object-fit: cover;
      border: 2px solid transparent;
      opacity: 0.6;
      transition: all 0.2s;
    }
    .gallery-thumb-item:hover {
      opacity: 1;
    }
    .gallery-thumb-item.active {
      border-color: #111827;
      opacity: 1;
    }


    /* 이미지 확대 모달 */
    #image-modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      justify-content: center;
      align-items: center;
      cursor: zoom-out;
    }
    #image-modal img {
      max-width: 95%;
      max-height: 95vh; /* 화면 높이에 맞춤 (세로사진 대응) */
      border-radius: 4px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      cursor: default;
      object-fit: contain;
    }

    .pill {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      display: inline-block;
      margin-right: 4px;
      margin-top: 2px;
    }
    .pill-yes {
      background: #dcfce7;
      color: #166534;
    }
    .pill-no {
      background: #fee2e2;
      color: #991b1b;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #f3f4f6;
      text-align: left;
    }
    th {
      background: #f9fafb;
    }
    .menu-row input[type="number"] {
      width: 60px;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-top: 12px;
      margin-bottom: 6px;
    }

    .btn-primary {
      padding: 8px 12px;
      border-radius: 999px;
      border: none;
      background: #111827;
      color: white;
      font-size: 13px;
      cursor: pointer;
    }
    .btn-secondary {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: white;
      font-size: 12px;
      cursor: pointer;
    }
    .field {
      margin-bottom: 10px;
    }
    .field label {
      display: block;
      font-size: 13px;
      margin-bottom: 3px;
    }
    .field input, .field textarea, .field select {
      width: 100%;
      padding: 6px 8px;
      font-size: 13px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    .highlight-box {
      border-radius: 10px;
      background: #f9fafb;
      padding: 10px;
      font-size: 12px;
      margin-bottom: 8px;
      border: 1px dashed #e5e7eb;
    }

    @media (max-width: 800px) {
      main {
        flex-direction: column;
      }
      #restaurant-list-view {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>

<header>
  <div>
    <div class="logo">행밥 단체 주문</div>
    <div class="subtitle">학과·동아리·학생회 단체 행사를 위한 간편 견적 요청</div>
  </div>
</header>

<main>
  <section id="restaurant-list-view">
    <h2>참여 음식점</h2>
    <div class="small" style="margin-bottom:8px;">
      주문할 음식점을 선택한 뒤, 오른쪽에서 메뉴 수량을 선택하고 견적서를 제출해주세요.
    </div>
    <div id="restaurant-list"></div>
  </section>

  <section id="right-panel">

    <div id="restaurant-detail-view" class="card">
      
      <div id="gallery-area" class="gallery-container" style="display:none;">
        <div class="gallery-main-frame" onclick="clickMainImage()">
          <img id="gallery-main-img" class="gallery-main-img" src="" alt="메인 이미지" />
        </div>
        <div id="gallery-thumbs" class="gallery-thumbs"></div>
      </div>

      <h2 id="rest-name">음식점을 먼저 선택해주세요</h2>
      <div id="rest-meta" class="small"></div>
      <div id="rest-notice" class="small" style="margin-top:4px;"></div>

      <h3>예약 가능 시간</h3>
      <div id="availability-container" class="small">왼쪽에서 음식점을 선택하면 예약 가능 시간이 표시됩니다.</div>

      <h3>메뉴 / 수량 / 비고</h3>
      <table>
        <thead>
          <tr>
            <th>메뉴</th>
            <th>기본 가격</th>
            <th>수량(최소~최대)</th>
            <th>비고</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="menu-body"></tbody>
      </table>
      <div class="small" style="margin-top:6px;">
        수량을 입력한 뒤 <b>담기</b>를 눌러주세요. 여러 메뉴를 함께 담을 수 있습니다.
      </div>
    </div>

    <div class="card">
      <h2>단체 주문 견적서</h2>
      <div class="highlight-box">
        <div><b>1)</b> 왼쪽에서 음식점 선택</div>
        <div><b>2)</b> 위에서 메뉴·수량 담기</div>
        <div><b>3)</b> 아래 견적서를 작성하고 제출</div>
      </div>
      <div id="cart-summary" class="small" style="margin-bottom:8px;">
        현재 담긴 메뉴가 없습니다. (메뉴를 담으면 여기에서 한 번에 확인할 수 있어요)
      </div>

      <form id="order-form">
        <div class="section-title">단체 정보</div>

        <div class="field">
          <label>단체 이름 / 학생회 이름</label>
          <input type="text" name="단체명" placeholder="예: 사회학과 학생회" required />
        </div>

        <div class="field">
          <label>담당자 이름</label>
          <input type="text" name="담당자명" placeholder="예: 홍길동" required />
        </div>

        <div class="field">
          <label>담당자 연락처</label>
          <input type="text" name="담당자_연락처" placeholder="예: 010-0000-0000" required />
        </div>

        <div class="field">
          <label>담당자 이메일</label>
          <input type="email" name="담당자_이메일" placeholder="견적 회신 받을 이메일" required />
        </div>

        <div class="section-title">배송 / 일정 정보</div>

        <div class="field">
          <label>배송 방법</label>
          <select name="배송_방법" required>
            <option value="">선택하세요</option>
            <option value="배달">배달</option>
            <option value="픽업">픽업</option>
          </select>
        </div>

        <div class="field">
          <label>배달 주소 (또는 픽업 수령 장소)</label>
          <input type="text" name="주소_또는_수령장소" placeholder="예: 고려대학교 ○○관 1층 로비" required />
        </div>

        <div class="field">
          <label>희망 날짜 / 시간</label>
          <input type="text" name="희망_일시" placeholder="예: 12월 10일(화) 11:30" required />
        </div>

        <div class="section-title">추가 요청사항</div>

        <div class="field">
          <label>요청사항 / 참고사항</label>
          <textarea name="추가_요청사항" placeholder="예: 포장 개별 포장 / 비건 메뉴 별도 구분 / 예산 범위 등"></textarea>
        </div>

        <div class="small" style="margin-bottom:8px;">
          제출을 누르면, 선택한 음식점·메뉴·수량·예상금액과 함께 Supabase DB에 저장됩니다.
        </div>

        <button type="submit" class="btn-primary">
          견적 요청 보내기
        </button>
      </form>
    </div>
  </section>
</main>

<div id="image-modal" onclick="closeModal()">
  <img id="modal-full-img" src="" alt="확대 이미지" />
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  // ===== 0. Supabase 연결 (여기만 네 프로젝트 값으로 바꾸기!) =====
  const SUPABASE_URL = "https://owfljerawghlyswtylxs.supabase.co"; 
  const SUPABASE_KEY = "sb_publishable_izKjuHR5y7O-xJANpPrS_A_ScU3hLrO"; 

  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ===== 1. 상태 저장 =====
  const state = {
    selectedRestaurantId: null,
    cart: [] // {restaurantId, menuId, name, qty, price}
  };
// ===== A. 기존 식당별 이미지/메타/태그/공지(정적 정보) =====
const STATIC_RESTAURANT_META = {
  '본죽': {
    images: ['res_Photo/bonjook1.png'],
    meta: '비빔밥/죽 · 100개 이상 · 3~4일 전 예약',
    tags: ['한식', '속편한 식사', '비빔밥'],
    notice: '배달, 픽업 둘다 가능',
    availability: []
  },
  '비비당': {
    images: [
      'res_Photo/bibidang1.png',
      'res_Photo/bibidang2.png',
      'res_Photo/bibidang3.png',
      'res_Photo/bibidang4.png',
      'res_Photo/bibidang5.png'
    ],
    meta: '비빔밥 · 100개 이상 · 2일 전 예약',
    tags: ['샐러드비빔밥(샐비)', '산채비빔밥', '건강식'],
    notice: '10~20인분 배달무료 / 100인분 이상 금액 협의 / 월요일은 11시 이후만 가능',
    availability: []
  },
  '고래돈가스': {
    images: ['res_Photo/goraedon.png'],
    meta: '돈가스 · 100개(협의) · 2일 전 예약',
    tags: ['돈가스 전문', '픽업 전용'],
    notice: '픽업만 가능 / 1~2시 불가',
    availability: []
  },
  '밀플랜비': {
    images: [
      'res_Photo/mealplanb1.png',
      'res_Photo/mealplanb2.png',
      'res_Photo/mealplanb3.png'
    ],
    meta: '샌드위치/부리또 · 100개(협의) · 5일 전 예약',
    tags: ['핫도그', '부리또', '간편식'],
    notice: '배달, 픽업 둘다 가능 / 100개 이하면 서비스',
    availability: []
  },
  '프로마치': {
    images: [
      'res_Photo/froma1.png',
      'res_Photo/froma2.png',
      'res_Photo/froma3.png',
      'res_Photo/froma4.png'
    ],
    meta: '샌드위치/파니니 · 100개 · 3~7일 전 예약',
    tags: ['파니니', '샌드위치', '비건옵션'],
    notice: '배달, 픽업 둘다 가능 / 100개 기준 1주일 전 예약 필요',
    availability: []
  },
  '치비치비': {
    images: ['res_Photo/chibechibe.jpeg'],
    meta: '양식/스테이크 · 50개(협의) · 7일 전 예약',
    tags: ['치킨스테이크', '양식'],
    notice: '픽업만 가능 / 포장시 음식이 식을 수 있음 / 보통맛·매운맛 선택 가능',
    availability: []
  },
  '스시미소': {
    images: ['res_Photo/sushimiso.png'],
    meta: '일식 · 100개 이상 · 당일~1일 전 예약',
    tags: ['초밥', '롤', '고급 도시락'],
    notice: '배달은 전날 예약',
    availability: []
  },
  '오봉집': {
    images: ['res_Photo/obong.png'],
    meta: '한식/볶음 · 100개 이상 · 1일 전 예약',
    tags: ['직화볶음', '보쌈', '점심할인'],
    notice: '픽업만 가능 / 11~15시 점심특선 가격 적용 가능',
    availability: []
  },
  '우승식당': {
    images: ['res_Photo/wooseng.png'],
    meta: '한식 · 100개(협의) · 당일~1일 전 예약',
    tags: ['제육', '두루치기', '가성비'],
    notice: '50개 이상 주문 시 서비스 제공 / 고기만 채운 도시락 형태',
    availability: []
  },
  '이공김밥': {
    images: ['res_Photo/eegong.png'],
    meta: '분식 · 100개 이상 · 1~3일 전 예약',
    tags: ['김밥', '돈가스', '가성비'],
    notice: '배달 협의 가능',
    availability: []
  }
};

// “원하는 메뉴 찾아드려요” 특수 식당 (DB 말고 프론트에서 계속 관리)
const AGENT_RESTAURANT = {
  id: 'r11',
  name: '더 다양한 메뉴를 원하신다면 알려주세요',
  images: ['res_Photo/agentMode.png'],
  meta: '희망하시는 메뉴에 맞춰 최적의 식당을 직접 찾아드립니다',
  tags: ['알아서 해드립니다'],
  notice: '조건에 맞는 식당이 없을 경우 가장 적합한 대안을 찾아, 최대 익일 18시 이전까지 연락드립니다.',
  availability: [],
  menus: [
    {
      id: 'm11_1',
      name: '원하는 메뉴를 찾아드려요. 추가요청사항에 카테고리, 개수, 예산, 요청사항을 적어주세요',
      price: 0,
      minQty: 1,
      maxQty: 999,
      note: ''
    }
  ]
};

// 기존에 보이던 식당 순서
const RESTAURANT_ORDER = [
  '본죽',
  '비비당',
  '고래돈가스',
  '밀플랜비',
  '프로마치',
  '치비치비',
  '스시미소',
  '오봉집',
  '우승식당',
  '이공김밥',
  '더 다양한 메뉴를 원하신다면 알려주세요'
];

  // ===== 2. 음식점 데이터 (imageUrl -> images 배열로 변경) =====
  // images: ['url1', 'url2', ...] 형태로 여러 장 넣으세요.
  // ===== 2. 음식점 데이터 (minQty: 10, maxQty: 999 통일) =====
  
  // ===== 2. DB에서 식당/메뉴 불러오기 =====
let restaurants = [];  // DB에서 채워질 전역 변수

async function loadRestaurantsFromDB() {
  // 1) 식당 목록
  const { data: restRows, error: restError } = await supabaseClient
    .from('restaurants')
    .select('*')
    .order('id', { ascending: true });

  if (restError) {
    console.error('restaurants 조회 오류', restError);
    alert('음식점 정보를 불러오는 중 문제가 발생했습니다.');
    return;
  }

  // 2) 메뉴 목록
  const { data: menuRows, error: menuError } = await supabaseClient
    .from('menus')
    .select('*')
    .order('restaurant_id', { ascending: true });

  if (menuError) {
    console.error('menus 조회 오류', menuError);
    alert('메뉴 정보를 불러오는 중 문제가 발생했습니다.');
    return;
  }

  // 3) restaurant_id 기준으로 메뉴 묶기
  const menuMap = {};
  menuRows.forEach(m => {
    if (!menuMap[m.restaurant_id]) menuMap[m.restaurant_id] = [];
    menuMap[m.restaurant_id].push({
      id: m.id,
      name: m.name,
      price: m.price,
      minQty: m.min_qty,
      maxQty: m.max_qty,
      note: m.note || ''
    });
  });

  // 4) 기존 코드에서 쓰던 형태로 변환
  // ===== 2. DB에서 식당/메뉴 불러오기 =====
let restaurants = [];  // 위에서 전역으로 선언하는 거 유지

async function loadRestaurantsFromDB() {
  const { data: restRows, error: restError } = await supabaseClient
    .from('restaurants')
    .select('*')
    .order('id', { ascending: true });

  if (restError) {
    console.error('restaurants 조회 오류', restError);
    alert('음식점 정보를 불러오는 중 문제가 발생했습니다.');
    return;
  }

  const { data: menuRows, error: menuError } = await supabaseClient
    .from('menus')
    .select('*')
    .order('restaurant_id', { ascending: true });

  if (menuError) {
    console.error('menus 조회 오류', menuError);
    alert('메뉴 정보를 불러오는 중 문제가 발생했습니다.');
    return;
  }

  const menuMap = {};
  menuRows.forEach(m => {
    if (!menuMap[m.restaurant_id]) menuMap[m.restaurant_id] = [];
    menuMap[m.restaurant_id].push({
      id: m.id,
      name: m.name,
      price: m.price,
      minQty: m.min_qty,
      maxQty: m.max_qty,
      note: m.note || ''
    });
  });

  // DB 데이터 + 정적 메타 정보를 합치기
  restaurants = restRows.map(r => {
    const meta = STATIC_RESTAURANT_META[r.name] || {};

    return {
      id: r.id,
      name: r.name,
      images: r.images && r.images.length ? r.images : (meta.images || []),
      meta: r.meta || meta.meta || '',
      tags: (r.tags && r.tags.length ? r.tags : (meta.tags || [])),
      notice: r.notice || meta.notice || '',
      availability: r.availability || meta.availability || [],
      menus: menuMap[r.id] || []
    };
  });

  // 마지막에 “원하는 메뉴 찾아드려요” 특수 식당 추가
  restaurants.push(AGENT_RESTAURANT);

  // 식당 순서를 기존과 같게 정렬
  restaurants.sort((a, b) => {
    const idxA = RESTAURANT_ORDER.indexOf(a.name);
    const idxB = RESTAURANT_ORDER.indexOf(b.name);
    return idxA - idxB;
  });
}

}

  
  // ===== 3. 렌더링 함수들 =====
  async function init() {
  // 1) DB에서 restaurants, menus 불러오기
  await loadRestaurantsFromDB();

  // 2) 나머지 기존 로직 그대로
  renderRestaurantList();
  if (restaurants.length > 0) {
    state.selectedRestaurantId = restaurants[0].id;
    renderRestaurantDetail();
  }
  renderCartSummary();

  const form = document.getElementById('order-form');
  form.addEventListener('submit', submitOrder);
}

  function renderRestaurantList() {
    const container = document.getElementById('restaurant-list');
    container.innerHTML = '';
    restaurants.forEach(r => {
      const card = document.createElement('div');
      card.className = 'restaurant-card';
      card.onclick = () => {
        state.selectedRestaurantId = r.id;
        renderRestaurantDetail();
        state.cart = state.cart.filter(item => item.restaurantId === r.id);
        renderCartSummary();
      };

      // 목록 썸네일 (첫 번째 이미지만 표시)
      if (r.images && r.images.length > 0) {
        const img = document.createElement('img');
        img.className = 'restaurant-thumb';
        img.src = r.images[0];
        img.alt = r.name + ' 이미지';
        card.appendChild(img);
      }

      const nameDiv = document.createElement('div');
      nameDiv.className = 'restaurant-name';
      nameDiv.textContent = r.name;

      const metaDiv = document.createElement('div');
      metaDiv.className = 'restaurant-meta';
      metaDiv.textContent = r.meta;

      const tagsDiv = document.createElement('div');
      r.tags.forEach(t => {
        const tagSpan = document.createElement('span');
        tagSpan.className = 'restaurant-tag';
        tagSpan.textContent = t;
        tagsDiv.appendChild(tagSpan);
      });

      card.appendChild(nameDiv);
      card.appendChild(metaDiv);
      card.appendChild(tagsDiv);

      container.appendChild(card);
    });
  }

  function getSelectedRestaurant() {
    return restaurants.find(r => r.id === state.selectedRestaurantId) || null;
  }

  function renderRestaurantDetail() {
    const rest = getSelectedRestaurant();
    const nameEl = document.getElementById('rest-name');
    const metaEl = document.getElementById('rest-meta');
    const noticeEl = document.getElementById('rest-notice');
    const availContainer = document.getElementById('availability-container');
    const menuBody = document.getElementById('menu-body');
    
    // 갤러리 요소들
    const galleryArea = document.getElementById('gallery-area');
    const galleryMainImg = document.getElementById('gallery-main-img');
    const galleryThumbs = document.getElementById('gallery-thumbs');

    if (!rest) {
      nameEl.textContent = '음식점을 먼저 선택해주세요';
      metaEl.textContent = '';
      noticeEl.textContent = '';
      availContainer.textContent = '왼쪽에서 음식점을 선택하면 예약 가능 시간이 표시됩니다.';
      menuBody.innerHTML = '';
      galleryArea.style.display = 'none';
      return;
    }

    // [갤러리 렌더링]
    if (rest.images && rest.images.length > 0) {
      galleryArea.style.display = 'block';
      // 메인 이미지를 첫 번째로 설정
      galleryMainImg.src = rest.images[0];
      galleryMainImg.style.display = 'block';

      // 썸네일 렌더링
      galleryThumbs.innerHTML = '';
      rest.images.forEach((imgUrl, idx) => {
        const thumb = document.createElement('img');
        thumb.src = imgUrl;
        thumb.className = 'gallery-thumb-item';
        if (idx === 0) thumb.classList.add('active'); // 첫 번째 활성화

        thumb.onclick = () => {
          // 메인 이미지 변경
          galleryMainImg.src = imgUrl;
          // 활성 상태 스타일 변경
          document.querySelectorAll('.gallery-thumb-item').forEach(el => el.classList.remove('active'));
          thumb.classList.add('active');
        };
        galleryThumbs.appendChild(thumb);
      });
    } else {
      galleryArea.style.display = 'none';
    }

    nameEl.textContent = rest.name;
    metaEl.textContent = rest.meta;
    noticeEl.textContent = '안내사항: ' + rest.notice;

    // 예약 가능 시간
    availContainer.innerHTML = '';
    rest.availability.forEach(day => {
      const dayDiv = document.createElement('div');
      dayDiv.style.marginBottom = '4px';
      const dateSpan = document.createElement('span');
      dateSpan.style.fontWeight = '600';
      dateSpan.textContent = day.date + ' ';
      dayDiv.appendChild(dateSpan);

      day.slots.forEach(s => {
        const pill = document.createElement('span');
        pill.className = 'pill ' + (s.available ? 'pill-yes' : 'pill-no');
        pill.textContent = s.time + (s.available ? ' 가능' : ' 불가');
        dayDiv.appendChild(pill);
      });

      availContainer.appendChild(dayDiv);
    });

    // 메뉴 리스트
    menuBody.innerHTML = '';
    rest.menus.forEach(menu => {
      const tr = document.createElement('tr');
      tr.className = 'menu-row';

      const tdName = document.createElement('td');
      tdName.textContent = menu.name;

      const tdPrice = document.createElement('td');
      tdPrice.textContent = menu.price.toLocaleString() + '원';

      const tdQty = document.createElement('td');
      const qtyInput = document.createElement('input');
      qtyInput.type = 'number';
      qtyInput.min = menu.minQty;
      qtyInput.max = menu.maxQty;
      qtyInput.value = menu.minQty;
      qtyInput.id = `qty-${rest.id}-${menu.id}`;
      tdQty.appendChild(qtyInput);
      const minMaxSpan = document.createElement('span');
      minMaxSpan.className = 'small';
      minMaxSpan.style.marginLeft = '4px';
      minMaxSpan.textContent = `(${menu.minQty}~${menu.maxQty}개)`;
      tdQty.appendChild(minMaxSpan);

      const tdDiscount = document.createElement('td');
      tdDiscount.textContent = menu.note;

      const tdBtn = document.createElement('td');
      const addBtn = document.createElement('button');
      addBtn.className = 'btn-secondary';
      addBtn.style.fontSize = '11px';
      addBtn.textContent = '담기';
      addBtn.type = 'button';
      addBtn.onclick = () => addToCart(rest.id, menu.id);
      tdBtn.appendChild(addBtn);

      tr.appendChild(tdName);
      tr.appendChild(tdPrice);
      tr.appendChild(tdQty);
      tr.appendChild(tdDiscount);
      tr.appendChild(tdBtn);

      menuBody.appendChild(tr);
    });
  }

  function addToCart(restaurantId, menuId) {
    const rest = restaurants.find(r => r.id === restaurantId);
    if (!rest) return;
    const menu = rest.menus.find(m => m.id === menuId);
    if (!menu) return;

    const qtyInput = document.getElementById(`qty-${restaurantId}-${menuId}`);
    const qty = parseInt(qtyInput.value, 10);
    if (isNaN(qty) || qty < menu.minQty || qty > menu.maxQty) {
      alert(`수량은 ${menu.minQty}~${menu.maxQty}개 사이로 입력해주세요.`);
      return;
    }

    const existing = state.cart.find(
      item => item.restaurantId === restaurantId && item.menuId === menuId
    );
    if (existing) {
      const newQty = existing.qty + qty;
      if (newQty > menu.maxQty) {
        alert(`최대 수량(${menu.maxQty}개)를 초과할 수 없습니다.`);
        return;
      }
      existing.qty = newQty;
    } else {
      state.cart.push({
        restaurantId,
        menuId,
        name: menu.name,
        qty,
        price: menu.price
      });
    }

    alert(`장바구니에 담았습니다.\n(${menu.name} x ${qty}개)`);
    renderCartSummary();
  }

  function renderCartSummary() {
    const summaryEl = document.getElementById('cart-summary');
    const rest = getSelectedRestaurant();
    const items = state.cart;
    if (!rest || items.length === 0) {
      summaryEl.textContent =
        '현재 담긴 메뉴가 없습니다. (메뉴를 담으면 여기에서 한 번에 확인할 수 있어요)';
      return;
    }

    let total = 0;
    let lines = items.map(item => {
      const lineTotal = item.price * item.qty;
      total += lineTotal;
      return `- ${item.name} x ${item.qty}개 = ${lineTotal.toLocaleString()}원`;
    });

    summaryEl.innerHTML =
      `<b>선택한 음식점:</b> ${rest.name}<br>` +
      lines.join('<br>') +
      `<br><br><b>예상 기본 금액 합계: ${total.toLocaleString()}원</b><br>` +
      `<span class="small">※ 실제 할인 및 최종 금액은 가게와 협의 후 확정됩니다.</span>`;
  }

  // ===== 모달 관련 함수 =====
  function clickMainImage() {
    const galleryMainImg = document.getElementById('gallery-main-img');
    openModal(galleryMainImg.src);
  }

  function openModal(src) {
    const modal = document.getElementById('image-modal');
    const modalImg = document.getElementById('modal-full-img');
    modalImg.src = src;
    modal.style.display = 'flex';
  }

  function closeModal() {
    const modal = document.getElementById('image-modal');
    modal.style.display = 'none';
  }

  // ===== 4. 주문 제출 → Supabase에 저장 (중복 방지 적용) =====
  async function submitOrder(event) {
    event.preventDefault();

    const rest = getSelectedRestaurant();
    if (!rest) {
      alert('먼저 왼쪽에서 음식점을 선택해주세요.');
      return;
    }
    if (state.cart.length === 0) {
      alert('메뉴를 하나 이상 담아주세요.');
      return;
    }

    // [중복 방지 1] 버튼 가져오기 및 상태 저장
    const form = document.getElementById('order-form');
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.textContent;

    // [중복 방지 2] 버튼 비활성화 및 텍스트 변경
    submitBtn.disabled = true;
    submitBtn.textContent = '제출 중입니다...';
    submitBtn.style.opacity = '0.7'; // 시각적으로 흐리게 처리
    submitBtn.style.cursor = 'not-allowed';

    const formData = new FormData(form);

    let total = 0;
    const items = state.cart.map(item => {
      const lineTotal = item.price * item.qty;
      total += lineTotal;
      return {
        name: item.name,
        qty: item.qty,
        price: item.price,
        line_total: lineTotal
      };
    });

    const payload = {
      restaurant_id: rest.id,
      restaurant_name: rest.name,
      items: items,
      total_amount: total,

      org_name: formData.get('단체명'),
      contact_name: formData.get('담당자명'),
      contact_phone: formData.get('담당자_연락처'),
      contact_email: formData.get('담당자_이메일'),

      delivery_type: formData.get('배송_방법'),
      address: formData.get('주소_또는_수령장소'),
      desired_datetime: formData.get('희망_일시'),
      memo: formData.get('추가_요청사항')
    };

    try {
      const { error } = await supabaseClient
        .from('orders')
        .insert([payload]);

      if (error) {
        console.error(error);
        alert('주문 저장 중 오류가 발생했습니다. 나중에 다시 시도해주세요.');
        return;
      }

      alert('견적 요청이 접수되었습니다! 행밥 팀에서 확인 후 연락드릴게요.');

      form.reset();
      state.cart = [];
      renderCartSummary();

    } catch (e) {
      console.error(e);
      alert('일시적인 오류가 발생했습니다. 나중에 다시 시도해주세요.');
    } finally {
      // [중복 방지 3] 성공하든 실패하든 처리가 끝나면 버튼 원상복구
      submitBtn.disabled = false;
      submitBtn.textContent = originalBtnText;
      submitBtn.style.opacity = '1';
      submitBtn.style.cursor = 'pointer';
    }
  }

  window.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
